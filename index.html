<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ff7a18" />
  <title>Meeting Timer</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg: #0b0b0f;
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --sub: rgba(255,255,255,.65);
      --muted: rgba(255,255,255,.45);

      --orange: #ff7a18;
      --orange2:#ff9a3c;

      --danger:#ff3b3b;
      --ok:#22c55e;

      --ink: #120b02;
      --radius: 18px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1100px 650px at 15% -10%, rgba(255,122,24,.20), transparent 55%),
                  radial-gradient(900px 550px at 110% 10%, rgba(255,154,60,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Noto Sans TC", sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }

    .app{
      max-width: 560px;
      margin: 0 auto;
      padding: 14px 0 96px; /* 留給底部 mini player */
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 10px;
      position: sticky;
      top: env(safe-area-inset-top);
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,11,15,.78), rgba(11,11,15,.42));
      z-index: 5;
    }

    .brand{ display:flex; flex-direction:column; gap:3px; }
    .brand .title{ font-size: 16px; letter-spacing: .2px; font-weight: 900; }
    .brand .desc{ font-size: 12px; color: var(--sub); }

    .pill{
      font-size:12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--sub);
      user-select:none;
      white-space: nowrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .stack{ display:flex; flex-direction:column; gap:12px; }

    .section-title{
      font-size: 13px;
      font-weight: 900;
      color: rgba(255,255,255,.85);
      margin: 2px 0 8px;
      display:flex; align-items:center; gap:8px;
    }
    .section-title .dot{
      width:8px; height:8px; border-radius:99px;
      background: linear-gradient(180deg, var(--orange), var(--orange2));
      box-shadow: 0 0 0 4px rgba(255,122,24,.12);
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:380px){ .grid2{ grid-template-columns: 1fr; } }

    .field{ display:flex; flex-direction:column; gap:6px; }
    .label{ font-size: 12px; color: var(--sub); }

    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(255,255,255,.35); }
    input:focus{
      border-color: rgba(255,122,24,.6);
      box-shadow: 0 0 0 4px rgba(255,122,24,.12);
    }

    /* Hide number spinners */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type="number"]{ -moz-appearance: textfield; }

    /* Pretty Select */
    .select-wrap{ position: relative; width: 100%; }
    .select-wrap select{
      width:100%;
      padding: 12px 44px 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size: 14px;
      appearance:none;
      -webkit-appearance:none;
      cursor:pointer;
    }
    .select-wrap select:focus{
      border-color: rgba(255,122,24,.6);
      box-shadow: 0 0 0 4px rgba(255,122,24,.12);
    }
    .select-wrap::after{
      content: "▾";
      position:absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,.75);
      font-size: 14px;
      pointer-events:none;
    }
    .select-wrap::before{
      content:"";
      position:absolute;
      right: 38px;
      top: 50%;
      transform: translateY(-50%);
      width: 1px;
      height: 22px;
      background: rgba(255,255,255,.12);
      pointer-events:none;
    }

    .seg{
      display:flex;
      gap:8px;
      padding: 6px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .seg button{
      flex:1;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--sub);
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
    }
    .seg button.active{
      background: linear-gradient(180deg, rgba(255,122,24,.22), rgba(255,122,24,.12));
      border-color: rgba(255,122,24,.45);
      color: rgba(255,255,255,.95);
    }

    .btnrow{ display:flex; gap:10px; }
    .btn{
      flex:1;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      font-weight: 950;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--orange), var(--orange2));
      color: var(--ink);
      box-shadow: 0 10px 22px rgba(255,122,24,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border-color: var(--border);
      color: rgba(255,255,255,.92);
    }
    .btn.danger{
      background: rgba(255,59,59,.12);
      border-color: rgba(255,59,59,.40);
      color: rgba(255,255,255,.92);
    }
    .btn.ok{
      background: rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.35);
      color: rgba(255,255,255,.92);
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .timer{
      background: linear-gradient(180deg, rgba(17,18,26,.95), rgba(20,22,39,.85));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
    }
    .timer.active{
      border-color: rgba(255,122,24,.45);
      box-shadow: 0 0 0 4px rgba(255,122,24,.10);
    }

    /* Running highlight */
    .timer.running{
      background: linear-gradient(180deg, rgba(255,122,24,.98), rgba(255,154,60,.92));
      border-color: rgba(255,122,24,.95);
      box-shadow: 0 0 0 4px rgba(255,122,24,.20);
    }
    .timer.running .tmeta,
    .timer.running .status{ color: rgba(18,11,2,.78); }
    .timer.running .badge{
      color: rgba(18,11,2,.85);
      background: rgba(255,255,255,.22);
      border-color: rgba(18,11,2,.18);
    }
    .timer.running .tname-input{
      color: rgba(18,11,2,.95);
      background: rgba(255,255,255,.24);
      border-color: rgba(18,11,2,.18);
    }
    .timer.running .time{
      color: rgba(18,11,2,.98);
      text-shadow: 0 1px 0 rgba(255,255,255,.12);
    }

    /* Running buttons obvious */
    .timer.running .btn.secondary{
      background: rgba(18,11,2,.88);
      border-color: rgba(18,11,2,.88);
      color: rgba(255,255,255,.95);
      box-shadow: 0 8px 18px rgba(18,11,2,.20);
    }
    .timer.running .btn.danger{
      background: rgba(255,59,59,.85);
      border-color: rgba(255,59,59,.95);
      color: rgba(255,255,255,.98);
      box-shadow: 0 10px 22px rgba(255,59,59,.18);
    }
    .timer.running .btn.primary{
      background: rgba(18,11,2,.92);
      color: rgba(255,255,255,.96);
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(18,11,2,.20);
    }

    .timer-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .tname-wrap{ display:flex; flex-direction:column; gap:6px; flex: 1; min-width: 0; }
    .tname-input{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: 15px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 8px 10px;
      width: 100%;
    }
    .tmeta{ color: var(--sub); font-size: 12px; line-height: 1.35; }
    .badge{
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--sub);
      white-space:nowrap;
    }

    .timer-main{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin-top: 10px;
    }
    .time{
      font-variant-numeric: tabular-nums;
      font-weight: 1000;
      font-size: 28px;
      letter-spacing:.6px;
    }
    .status{
      font-size: 12px;
      color: var(--sub);
      text-align:right;
      max-width: 55%;
    }

    .actions{
      display:flex;
      gap:8px;
      margin-top: 10px;
      flex-wrap: nowrap;
    }
    .actions .btn{
      padding: 10px 10px;
      font-size: 13px;
      border-radius: 12px;
      flex: 1;
      min-width: 0;
    }

    .host-row{
      margin-top: 10px;
      display:flex;
      gap:10px;
    }
    .host-row .btn{
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 14px;
    }
    .host-row .btn.primary{ flex: 2; }
    .host-row .btn.secondary{ flex: 1; }

    .reorder{
      display:flex;
      gap:8px;
      margin-top: 10px;
    }
    .reorder .btn{
      padding: 10px 10px;
      font-size: 13px;
      border-radius: 12px;
      flex: 1;
    }

    .empty{
      text-align:center;
      color: var(--sub);
      padding: 18px 10px;
      border: 1px dashed rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
    }
    .footerhint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      padding: 0 8px;
    }

    /* Pretty file upload */
    .file-wrap{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
    }
    .file-wrap .file-btn{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,122,24,.45);
      background: linear-gradient(180deg, rgba(255,122,24,.16), rgba(255,122,24,.08));
      color: rgba(255,255,255,.94);
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .file-wrap .file-name{
      font-size: 13px;
      color: var(--sub);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
    }
    .file-wrap input[type="file"]{ display:none; }

    /* Fullscreen overlay */
    .overlay{
      position: fixed;
      inset: 0;
      background: radial-gradient(900px 600px at 10% 0%, rgba(255,122,24,.22), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(255,154,60,.10), transparent 55%),
                  var(--bg);
      z-index: 9990;
      display: none;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }
    .overlay.show{ display:block; }
    .overlay-inner{
      max-width: 680px;
      margin: 0 auto;
      height: 100%;
      display:flex;
      flex-direction:column;
      justify-content: space-between;
      gap: 12px;
    }

    .fs-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding-top: 6px;
    }
    .fs-title{ font-weight: 1000; font-size: 16px; letter-spacing: .2px; }
    .fs-sub{ font-size: 12px; color: var(--sub); margin-top: 4px; }

    .fs-time{
      font-variant-numeric: tabular-nums;
      font-weight: 1000;
      font-size: clamp(56px, 11vw, 104px);
      letter-spacing: 1px;
      text-align:center;
      margin-top: 8vh;
    }
    .fs-status{
      text-align:center;
      margin-top: 10px;
      font-size: 14px;
      color: var(--sub);
    }

    .fs-actions{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      padding-bottom: 8px;
    }
    .fs-actions .btn{
      flex: 1 1 140px;
      padding: 14px 12px;
      border-radius: 16px;
      font-size: 14px;
    }

    /* Bottom Sheet */
    .sheet-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 9998;
      display:none;
    }
    .sheet-backdrop.show{ display:block; }

    .sheet{
      position: fixed;
      left:0; right:0;
      bottom:0;
      z-index: 9999;
      transform: translateY(110%);
      transition: transform .22s ease;
      padding: 0 12px env(safe-area-inset-bottom) 12px;
    }
    .sheet.show{ transform: translateY(0%); }
    .sheet-card{
      max-width: 680px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(17,18,26,.98), rgba(20,22,39,.95));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheet-handle{
      height: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sheet-handle::before{
      content:"";
      width: 44px;
      height: 4px;
      border-radius: 99px;
      background: rgba(255,255,255,.20);
    }
    .sheet-body{ padding: 6px 14px 14px; }
    .sheet-title{ font-weight: 1000; font-size: 15px; margin-bottom: 4px; }
    .sheet-desc{ font-size: 12px; color: var(--sub); margin-bottom: 12px; line-height: 1.4; }
    .sheet-actions{ display:flex; gap:10px; flex-wrap: wrap; }
    .sheet-actions .btn{
      flex: 1 1 120px;
      border-radius: 16px;
      padding: 13px 12px;
    }

    /* Mini player (Spotify-style) */
    .mini-player{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 9000;
      display:none;
    }
    .mini-player.show{ display:block; }
    .mini-player-card{
      max-width: 560px;
      margin: 0 auto;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,122,24,.35);
      background: linear-gradient(180deg, rgba(255,122,24,.22), rgba(17,18,26,.92));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mp-left{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
      flex: 1;
    }
    .mp-title{
      font-weight: 1000;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .mp-time{
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      color: rgba(255,255,255,.78);
    }
    .mp-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex: 0 0 auto;
    }
    .icon-btn{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.95);
      font-weight: 1000;
      font-size: 18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .icon-btn:active{ transform: translateY(1px); }
    .icon-btn.primary{
      background: rgba(0,0,0,.42);
      border-color: rgba(255,255,255,.22);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="title">倒數計時器</div>
        <div class="desc">你的時間控制小幫手</div>
      </div>
      <div class="pill" id="pwaHint">輕鬆使用</div>
    </div>

    <div class="stack">
      <!-- Quick controls -->
      <div class="card">
        <div class="section-title"><span class="dot"></span>快速控制</div>
        <div class="btnrow">
          <button class="btn secondary" id="btnStartPause" type="button">開始 / 暫停</button>
          <button class="btn secondary" id="btnNext" type="button">下一段</button>
          <button class="btn secondary" id="btnFullscreen" type="button">全螢幕</button>
        </div>
        <div class="mini" style="margin-top:8px;">
          開始 / 暫停會優先控制正在倒數中的計時器；沒有時就控制目前選取段落。
        </div>
      </div>

      <!-- Add timer -->
      <div class="card">
        <div class="section-title"><span class="dot"></span>新增計時器</div>

        <div class="field">
          <div class="label">名稱</div>
          <input id="name" type="text" placeholder="例如：簡報 / 討論 / QA" />
        </div>

        <div class="field" style="margin-top:10px;">
          <div class="label">模式</div>
          <div class="seg">
            <button id="modeCountdown" class="active" type="button">倒數</button>
            <button id="modeEndtime" type="button">結束時間</button>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field" id="countdownField">
            <div class="label">倒數分鐘</div>
            <input id="minutes" type="number" inputmode="numeric" min="1" value="10" />
          </div>

          <div class="field" id="endtimeField" style="display:none;">
            <div class="label">結束時間</div>
            <input id="endtime" type="time" />
          </div>

          <div class="field">
            <div class="label">提前提醒</div>
            <div class="select-wrap">
              <select id="prealert">
                <option value="0">不需提前提醒</option>
                <option value="5">提前 5 分鐘</option>
                <option value="10">提前 10 分鐘</option>
                <option value="15">提前 15 分鐘</option>
              </select>
            </div>
          </div>

          <div class="field">
            <div class="label">播放秒數（ 自動停止 ）</div>
            <input id="playSeconds" type="number" inputmode="numeric" min="1" value="10" />
          </div>
        </div>

        <div class="btnrow" style="margin-top:12px;">
          <button class="btn primary" id="add" type="button">新增</button>
          <button class="btn danger" id="clearAll" type="button">清空全部</button>
        </div>
      </div>

      <!-- Sound -->
      <div class="card">
        <div class="section-title"><span class="dot"></span>提醒鈴聲</div>

        <div class="grid2">
          <div class="field">
            <div class="label">預設鈴聲</div>
            <div class="select-wrap">
              <select id="preset">
                <option value="soft">柔和提醒</option>
                <option value="lively">活潑提醒</option>
                <option value="urgent">急促提醒</option>
              </select>
            </div>
          </div>

          <div class="field">
            <div class="label">自訂音檔</div>
            <div class="file-wrap">
              <label class="file-btn" for="file">選擇檔案</label>
              <div class="file-name" id="fileName">未選擇</div>
              <input id="file" type="file" accept="audio/*" />
            </div>
          </div>
        </div>

        <div class="btnrow" style="margin-top:10px;">
          <button class="btn secondary" id="preview" type="button">試聽</button>
          <button class="btn secondary" id="stop" type="button">停止</button>
        </div>

        <div class="field" style="margin-top:10px;">
          <div class="label">音量</div>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="0.7" />
        </div>

        <div class="mini" style="margin-top:8px;">
          第一次用時先按一次「 試聽 」或「 開始 」，讓瀏覽器允許播放音訊。設定會自動記住。
        </div>
      </div>

      <!-- Timers -->
      <div class="card">
        <div class="section-title"><span class="dot"></span>計時器</div>
        <div class="mini" style="margin-top:-2px; margin-bottom:8px;">
          桌機可拖曳排序；手機可用上移 / 下移調整順序。
        </div>
        <div id="empty" class="empty">還沒有計時器，先新增一個吧！</div>
        <div id="list" class="list"></div>

        <div class="footerhint">
          PWA：用 HTTPS（ 或 localhost ）可安裝並離線使用。
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen overlay -->
  <div class="overlay" id="overlay">
    <div class="overlay-inner">
      <div class="fs-top">
        <div>
          <div class="fs-title" id="fsTitle">主持人模式</div>
          <div class="fs-sub" id="fsSub">選一段開始計時</div>
        </div>
        <button class="btn secondary" id="fsExit" type="button">退出</button>
      </div>

      <div>
        <div class="fs-time" id="fsTime">00:00:00</div>
        <div class="fs-status" id="fsStatus">尚未開始</div>
      </div>

      <div>
        <div class="fs-actions">
          <button class="btn secondary" id="fsStartPause" type="button">開始 / 暫停</button>
          <button class="btn secondary" id="fsNextNamed" type="button">下一段</button>
          <button class="btn danger" id="fsReset" type="button">重置</button>
        </div>

        <div class="mini" style="margin-top:10px; text-align:center;">
          時間到會自動跳出延後選單。
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="sheet">
    <div class="sheet-card">
      <div class="sheet-handle"></div>
      <div class="sheet-body">
        <div class="sheet-title" id="sheetTitle">延後提醒</div>
        <div class="sheet-desc" id="sheetDesc">選擇要延後的時間</div>
        <div class="sheet-actions">
          <button class="btn ok" data-snooze="5" type="button">延後 5 分</button>
          <button class="btn ok" data-snooze="10" type="button">延後 10 分</button>
          <button class="btn ok" data-snooze="15" type="button">延後 15 分</button>
          <button class="btn secondary" id="sheetCancel" type="button">先不要</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini Player -->
  <div class="mini-player" id="miniPlayer">
    <div class="mini-player-card">
      <div class="mp-left">
        <div class="mp-title" id="mpTitle">尚未開始</div>
        <div class="mp-time" id="mpTime">00:00:00</div>
      </div>
      <div class="mp-actions">
        <button class="icon-btn primary" id="mpPlayPause" type="button" aria-label="Play/Pause">▶</button>
        <button class="icon-btn" id="mpNext" type="button" aria-label="Next">⏭</button>
      </div>
    </div>
  </div>

  <script>
    // PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    // Helpers
    const el = (id) => document.getElementById(id);
    const clampInt = (v, min, max) => Math.max(min, Math.min(max, v|0));
    const nowTs = () => Date.now();

    function format(ms) {
      ms = Math.max(0, ms);
      const h = String(Math.floor(ms / 3600000)).padStart(2,'0');
      const m = String(Math.floor((ms % 3600000) / 60000)).padStart(2,'0');
      const s = String(Math.floor((ms % 60000) / 1000)).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (s) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }

    // Storage
    const STORAGE_KEY = "meeting_timer_pwa_v5";

    function saveState() {
      const timersArr = state.order.map(id => state.timers[id]).filter(Boolean);
      const data = {
        version: 5,
        nextId: state.nextId,
        order: state.order,
        activeId: state.activeId,
        lastControlId: state.lastControlId, // NEW
        sound: {
          preset: state.sound.preset,
          volume: state.sound.volume,
          playSeconds: state.sound.playSeconds,
          customName: state.sound.customName || null
        },
        timers: timersArr.map(t => ({
          id: t.id,
          name: t.name,
          mode: t.mode,
          minutes: t.minutes,
          endtime: t.endtime,
          prealertMin: t.prealertMin,
          remainingMs: t.remainingMs,
          status: t.status,
          finished: t.finished,
          prealertTriggered: t.prealertTriggered
        }))
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    // Sound presets
    const PRESET_SOUNDS = {
      soft:   { label: "柔和提醒", url: "https://actions.google.com/sounds/v1/alarms/medium_bell_ringing_near.ogg" },
      lively: { label: "活潑提醒", url: "https://actions.google.com/sounds/v1/cartoon/jingle_bells.ogg?hl=zh-tw" },
      urgent: { label: "急促提醒", url: "https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg?hl=zh-tw" }
    };

    const audio = new Audio(PRESET_SOUNDS.soft.url);
    let stopTimeout = null;

    function stopAudio() {
      if (stopTimeout) { clearTimeout(stopTimeout); stopTimeout = null; }
      audio.pause();
      audio.currentTime = 0;
    }

    function playAlertSound() {
      stopAudio();
      audio.currentTime = 0;
      const p = audio.play();
      if (p && p.catch) p.catch(() => {});
      const sec = Math.max(1, state.sound.playSeconds);
      stopTimeout = setTimeout(() => stopAudio(), sec * 1000);
    }

    // State
    const state = {
      nextId: 1,
      order: [],
      timers: {},
      activeId: null,
      lastControlId: null, // NEW: 最後被控制的段落
      sound: {
        preset: "soft",
        volume: 0.7,
        playSeconds: 10,
        customName: null,
        customUrl: null
      }
    };

    function computeEndDiff(endStr) {
      if (!endStr) return -1;
      const [hh, mm] = endStr.split(':').map(n => parseInt(n,10));
      const now = new Date();
      const end = new Date();
      end.setHours(hh, mm, 0, 0);
      return end.getTime() - now.getTime();
    }

    function createTimer({name, mode, minutes, endtime, prealertMin}) {
      const id = state.nextId++;
      const remainingMs = mode === "countdown"
        ? minutes * 60 * 1000
        : Math.max(0, computeEndDiff(endtime));
      return {
        id,
        name,
        mode,
        minutes: minutes || 0,
        endtime: endtime || "",
        prealertMin: prealertMin || 0,
        remainingMs,
        targetTs: null,
        interval: null,
        prealertTriggered: false,
        status: "尚未開始",
        finished: false
      };
    }

    // UI refs
    const pwaHint = el('pwaHint');

    const modeCountdownBtn = el('modeCountdown');
    const modeEndtimeBtn = el('modeEndtime');
    const countdownField = el('countdownField');
    const endtimeField = el('endtimeField');

    const nameInput = el('name');
    const minutesInput = el('minutes');
    const endtimeInput = el('endtime');
    const prealertSelect = el('prealert');
    const playSecondsInput = el('playSeconds');

    const addBtn = el('add');
    const clearAllBtn = el('clearAll');

    const presetSelect = el('preset');
    const fileInput = el('file');
    const fileName = el('fileName');
    const previewBtn = el('preview');
    const stopBtn = el('stop');
    const volumeSlider = el('volume');

    const btnStartPause = el('btnStartPause');
    const btnNext = el('btnNext');
    const btnFullscreen = el('btnFullscreen');

    const empty = el('empty');
    const list = el('list');

    const overlay = el('overlay');
    const fsTitle = el('fsTitle');
    const fsSub = el('fsSub');
    const fsTime = el('fsTime');
    const fsStatus = el('fsStatus');
    const fsExit = el('fsExit');
    const fsStartPause = el('fsStartPause');
    const fsNextNamed = el('fsNextNamed');
    const fsReset = el('fsReset');

    const sheetBackdrop = el('sheetBackdrop');
    const sheet = el('sheet');
    const sheetTitle = el('sheetTitle');
    const sheetDesc = el('sheetDesc');
    const sheetCancel = el('sheetCancel');

    const miniPlayer = el('miniPlayer');
    const mpTitle = el('mpTitle');
    const mpTime = el('mpTime');
    const mpPlayPause = el('mpPlayPause');
    const mpNext = el('mpNext');

    let sheetTimerId = null;
    let currentMode = 'countdown';

    function setMode(mode) {
      currentMode = mode;
      if (mode === 'countdown') {
        modeCountdownBtn.classList.add('active');
        modeEndtimeBtn.classList.remove('active');
        countdownField.style.display = '';
        endtimeField.style.display = 'none';
      } else {
        modeEndtimeBtn.classList.add('active');
        modeCountdownBtn.classList.remove('active');
        endtimeField.style.display = '';
        countdownField.style.display = 'none';
      }
    }
    modeCountdownBtn.addEventListener('click', () => setMode('countdown'));
    modeEndtimeBtn.addEventListener('click', () => setMode('endtime'));

    // Running / selection
    function isRunning(id) {
      const t = state.timers[id];
      return !!(t && t.interval);
    }

    function getRunningId() {
      for (const id of state.order) {
        if (isRunning(id)) return id;
      }
      return null;
    }

    // NEW: mini player target = runningId OR lastControlId
    function getMiniTargetId() {
      const runningId = getRunningId();
      if (runningId) return runningId;

      const lc = state.lastControlId;
      if (lc && state.timers[lc]) return lc;

      // fallback：active
      if (state.activeId && state.timers[state.activeId]) return state.activeId;

      return null;
    }

    function setActive(id) {
      state.activeId = id;
      for (const tid of state.order) {
        const card = el(`timer-${tid}`);
        if (card) card.classList.toggle('active', tid === id);
      }
      saveState();
      if (overlay.classList.contains('show')) syncOverlay();
      syncQuickControls();
      syncMiniPlayer();
    }

    // Render
    function render() {
      list.innerHTML = "";
      if (state.order.length === 0) {
        empty.style.display = "block";
        syncMiniPlayer();
        return;
      }
      empty.style.display = "none";

      for (const id of state.order) {
        const t = state.timers[id];
        if (!t) continue;

        const meta = t.mode === 'countdown'
          ? `倒數 ${t.minutes} 分鐘${t.prealertMin>0 ? ` · 提前 ${t.prealertMin} 分鐘` : ''}`
          : `結束 ${t.endtime}${t.prealertMin>0 ? ` · 提前 ${t.prealertMin} 分鐘` : ''}`;

        const card = document.createElement('div');
        const running = isRunning(id);
        card.className = 'timer' + (state.activeId === id ? ' active' : '') + (running ? ' running' : '');
        card.id = `timer-${id}`;
        card.draggable = true;
        card.dataset.id = id;

        card.innerHTML = `
          <div class="timer-head">
            <div class="tname-wrap">
              <input class="tname-input" data-name-id="${id}" value="${escapeHtml(t.name)}" />
              <div class="tmeta">${escapeHtml(meta)}</div>
            </div>
            <div class="badge">#${id}</div>
          </div>

          <div class="timer-main">
            <div class="time" id="time-${id}">${format(t.remainingMs)}</div>
            <div class="status" id="status-${id}">${escapeHtml(t.status)}</div>
          </div>

          <div class="actions">
            <button class="btn secondary" data-action="start" data-id="${id}" type="button">開始</button>
            <button class="btn secondary" data-action="pause" data-id="${id}" type="button">暫停</button>
            <button class="btn secondary" data-action="reset" data-id="${id}" type="button">重置</button>
            <button class="btn danger" data-action="delete" data-id="${id}" type="button">刪除</button>
          </div>

          <div class="host-row">
            <button class="btn primary" data-action="fullscreen" data-id="${id}" type="button">全螢幕</button>
            <button class="btn secondary" data-action="snooze" data-id="${id}" type="button">延後</button>
          </div>

          <div class="reorder">
            <button class="btn secondary" data-action="up" data-id="${id}" type="button">上移</button>
            <button class="btn secondary" data-action="down" data-id="${id}" type="button">下移</button>
          </div>
        `;
        list.appendChild(card);
      }

      if (overlay.classList.contains('show')) syncOverlay();
      syncQuickControls();
      syncMiniPlayer();
    }

    function updateCard(id) {
      const t = state.timers[id];
      if (!t) return;

      const timeEl = el(`time-${id}`);
      const statusEl = el(`status-${id}`);
      if (timeEl) timeEl.textContent = format(t.remainingMs);
      if (statusEl) statusEl.textContent = t.status;

      const card = el(`timer-${id}`);
      if (card) {
        const running = isRunning(id);
        card.classList.toggle('active', state.activeId === id);
        card.classList.toggle('running', running);
      }

      if (overlay.classList.contains('show')) syncOverlay();
      syncQuickControls();
      syncMiniPlayer();
    }

    // Timer engine
    function markControlled(id) {
      state.lastControlId = id;
      saveState();
    }

    function startTimer(id) {
      const t = state.timers[id];
      if (!t || t.interval) return;

      setActive(id);
      markControlled(id);

      t.finished = false;
      t.prealertTriggered = false;

      const now = nowTs();
      if (t.mode === 'countdown') {
        if (t.remainingMs <= 0) t.remainingMs = t.minutes * 60 * 1000;
        t.targetTs = now + t.remainingMs;
        t.status = "倒數中";
      } else {
        const diff = computeEndDiff(t.endtime);
        if (diff <= 0) {
          t.status = "結束時間已過";
          t.remainingMs = 0;
          updateCard(id);
          saveState();
          return;
        }
        t.remainingMs = diff;
        t.targetTs = now + diff;
        t.status = `到 ${t.endtime}`;
      }

      updateCard(id);
      saveState();

      const preMs = t.prealertMin * 60 * 1000;

      t.interval = setInterval(() => {
        const diff = t.targetTs - nowTs();
        t.remainingMs = diff;

        if (diff <= 0) {
          clearInterval(t.interval);
          t.interval = null;
          t.remainingMs = 0;
          t.status = "時間到！";
          t.finished = true;
          updateCard(id);
          saveState();
          playAlertSound();
          openSnoozeSheet(id, true);
          return;
        }

        if (!t.prealertTriggered && preMs > 0 && diff <= preMs) {
          t.prealertTriggered = true;
          t.status = "提前提醒";
          updateCard(id);
          saveState();
          playAlertSound();
          return;
        }

        updateCard(id);
      }, 1000);
    }

    function pauseTimer(id) {
      const t = state.timers[id];
      if (!t || !t.interval) return;
      clearInterval(t.interval);
      t.interval = null;
      t.status = "已暫停";
      markControlled(id);
      updateCard(id);
      saveState();
    }

    function resetTimer(id) {
      const t = state.timers[id];
      if (!t) return;
      if (t.interval) { clearInterval(t.interval); t.interval = null; }
      t.prealertTriggered = false;
      t.finished = false;
      t.status = "已重置";
      markControlled(id);

      if (t.mode === 'countdown') {
        t.remainingMs = t.minutes * 60 * 1000;
      } else {
        const diff = computeEndDiff(t.endtime);
        t.remainingMs = Math.max(0, diff);
      }

      updateCard(id);
      saveState();
    }

    function deleteTimer(id) {
      const t = state.timers[id];
      if (!t) return;
      if (t.interval) clearInterval(t.interval);

      delete state.timers[id];
      state.order = state.order.filter(x => x !== id);

      if (state.activeId === id) state.activeId = null;
      if (state.lastControlId === id) state.lastControlId = null;

      render();
      saveState();
    }

    function snoozeTimer(id, minutes) {
      const t = state.timers[id];
      if (!t) return;

      if (t.interval) {
        clearInterval(t.interval);
        t.interval = null;
      }

      const addMs = minutes * 60 * 1000;
      t.remainingMs = Math.max(0, t.remainingMs) + addMs;
      t.prealertTriggered = true;
      t.finished = false;
      t.status = `延後 ${minutes} 分鐘`;
      markControlled(id);

      updateCard(id);
      saveState();

      startTimer(id);
    }

    // Next segment
    function getNextId() {
      if (state.order.length === 0) return null;

      const runningId = getRunningId();
      let startFromIdx = -1;
      if (runningId) startFromIdx = state.order.indexOf(runningId);
      else if (state.activeId) startFromIdx = state.order.indexOf(state.activeId);
      else if (state.lastControlId) startFromIdx = state.order.indexOf(state.lastControlId);

      const nextIdx = startFromIdx >= 0 ? startFromIdx + 1 : 0;
      return state.order[nextIdx] ?? state.order[0] ?? null;
    }

    function nextSegment() {
      if (state.order.length === 0) return;

      const runningId = getRunningId();
      if (runningId) pauseTimer(runningId);

      const nextId = getNextId();
      if (!nextId) return;

      startTimer(nextId);
      setActive(nextId);
      markControlled(nextId);
    }

    function updateNextNamedButton() {
      const nextId = getNextId();
      if (!nextId || !state.timers[nextId]) {
        fsNextNamed.textContent = "下一段";
        return;
      }
      fsNextNamed.textContent = `下一段：${state.timers[nextId].name}`;
    }

    // Reorder
    function moveUp(id) {
      const idx = state.order.indexOf(id);
      if (idx <= 0) return;
      const tmp = state.order[idx - 1];
      state.order[idx - 1] = state.order[idx];
      state.order[idx] = tmp;
      render();
      saveState();
    }

    function moveDown(id) {
      const idx = state.order.indexOf(id);
      if (idx < 0 || idx >= state.order.length - 1) return;
      const tmp = state.order[idx + 1];
      state.order[idx + 1] = state.order[idx];
      state.order[idx] = tmp;
      render();
      saveState();
    }

    let dragSrcId = null;
    list.addEventListener('dragstart', (e) => {
      const card = e.target.closest('.timer');
      if (!card) return;
      dragSrcId = parseInt(card.dataset.id, 10);
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain', String(dragSrcId)); } catch {}
    });
    list.addEventListener('dragover', (e) => {
      if (!dragSrcId) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    list.addEventListener('drop', (e) => {
      e.preventDefault();
      const dstCard = e.target.closest('.timer');
      if (!dstCard) return;
      const dstId = parseInt(dstCard.dataset.id, 10);
      const srcId = dragSrcId;
      dragSrcId = null;
      if (!srcId || !dstId || srcId === dstId) return;

      const srcIdx = state.order.indexOf(srcId);
      const dstIdx = state.order.indexOf(dstId);
      if (srcIdx < 0 || dstIdx < 0) return;

      state.order.splice(srcIdx, 1);
      state.order.splice(dstIdx, 0, srcId);

      render();
      saveState();
    });

    // Fullscreen
    function openHostMode(forId=null) {
      if (forId) setActive(forId);
      overlay.classList.add('show');
      syncOverlay();
      const root = document.documentElement;
      if (root.requestFullscreen) root.requestFullscreen().catch(() => {});
      syncMiniPlayer();
    }

    function closeHostMode() {
      overlay.classList.remove('show');
      if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
      }
      syncMiniPlayer();
    }

    function syncOverlay() {
      const id = state.activeId;
      if (!id || !state.timers[id]) {
        fsTitle.textContent = "主持人模式";
        fsSub.textContent = "選一段開始計時";
        fsTime.textContent = "00:00:00";
        fsStatus.textContent = "尚未開始";
        updateNextNamedButton();
        return;
      }

      const t = state.timers[id];
      fsTitle.textContent = t.name;
      fsSub.textContent = (t.mode === "countdown")
        ? `倒數 ${t.minutes} 分鐘${t.prealertMin>0 ? ` · 提前 ${t.prealertMin} 分` : ''}`
        : `結束 ${t.endtime}${t.prealertMin>0 ? ` · 提前 ${t.prealertMin} 分` : ''}`;

      fsTime.textContent = format(t.remainingMs);
      fsStatus.textContent = t.status;
      updateNextNamedButton();
    }

    el('fsExit').addEventListener('click', () => closeHostMode());
    el('fsNextNamed').addEventListener('click', () => nextSegment());
    el('fsReset').addEventListener('click', () => {
      if (!state.activeId) return;
      resetTimer(state.activeId);
    });
    el('fsStartPause').addEventListener('click', () => {
      const id = pickControlId();
      if (!id) return;
      if (isRunning(id)) pauseTimer(id);
      else startTimer(id);
    });

    // Bottom sheet
    function openSnoozeSheet(id, auto=false) {
      const t = state.timers[id];
      if (!t) return;
      sheetTimerId = id;
      sheetTitle.textContent = auto ? "時間到！要延後嗎？" : "延後提醒";
      sheetDesc.textContent = `段落：${t.name}。選擇要延後的時間。`;
      sheetBackdrop.classList.add('show');
      sheet.classList.add('show');
    }
    function closeSnoozeSheet() {
      sheetTimerId = null;
      sheetBackdrop.classList.remove('show');
      sheet.classList.remove('show');
    }
    sheetBackdrop.addEventListener('click', closeSnoozeSheet);
    sheetCancel.addEventListener('click', closeSnoozeSheet);
    sheet.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-snooze]');
      if (!btn) return;
      const mins = parseInt(btn.dataset.snooze, 10);
      const id = sheetTimerId;
      if (!id) return;
      closeSnoozeSheet();
      snoozeTimer(id, mins);
    });

    // Quick controls
    function pickControlId() {
      const runningId = getRunningId();
      if (runningId) return runningId;
      if (state.activeId) return state.activeId;
      if (state.lastControlId) return state.lastControlId;
      return null;
    }

    function syncQuickControls() {
      const id = pickControlId();
      if (!id || !state.timers[id]) {
        btnStartPause.textContent = "開始 / 暫停";
        return;
      }
      btnStartPause.textContent = isRunning(id) ? "暫停" : "開始";
    }

    btnStartPause.addEventListener('click', () => {
      const id = pickControlId();
      if (!id) return;
      if (isRunning(id)) pauseTimer(id);
      else startTimer(id);
    });
    btnNext.addEventListener('click', () => nextSegment());
    btnFullscreen.addEventListener('click', () => openHostMode(state.activeId));

    // NEW: Mini player (show on running OR lastControl)
    function syncMiniPlayer() {
      if (overlay.classList.contains('show')) {
        miniPlayer.classList.remove('show');
        return;
      }

      const id = getMiniTargetId();
      if (!id || !state.timers[id]) {
        miniPlayer.classList.remove('show');
        return;
      }

      const t = state.timers[id];
      mpTitle.textContent = t.name;
      mpTime.textContent = format(t.remainingMs);

      // icon switch: running -> pause, paused -> play
      mpPlayPause.textContent = isRunning(id) ? "❚❚" : "▶";

      miniPlayer.classList.add('show');
    }

    mpPlayPause.addEventListener('click', () => {
      const id = getMiniTargetId();
      if (!id || !state.timers[id]) return;

      if (isRunning(id)) pauseTimer(id);
      else startTimer(id);

      markControlled(id);
      syncMiniPlayer();
    });

    mpNext.addEventListener('click', () => {
      nextSegment();
      syncMiniPlayer();
    });

    // List actions + rename
    list.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      const id = parseInt(btn.dataset.id, 10);
      if (!id) return;

      setActive(id);
      markControlled(id);

      if (action === 'start') startTimer(id);
      if (action === 'pause') pauseTimer(id);
      if (action === 'reset') resetTimer(id);
      if (action === 'delete') deleteTimer(id);
      if (action === 'fullscreen') openHostMode(id);
      if (action === 'snooze') openSnoozeSheet(id, false);
      if (action === 'up') moveUp(id);
      if (action === 'down') moveDown(id);
    });

    list.addEventListener('keydown', (e) => {
      const input = e.target.closest('input[data-name-id]');
      if (!input) return;
      if (e.key === 'Enter') input.blur();
    });

    list.addEventListener('input', (e) => {
      const input = e.target.closest('input[data-name-id]');
      if (!input) return;
      const id = parseInt(input.dataset.nameId, 10);
      const t = state.timers[id];
      if (!t) return;
      t.name = input.value.slice(0, 60);
      saveState();
      if (overlay.classList.contains('show') && state.activeId === id) syncOverlay();
      updateNextNamedButton();
      syncMiniPlayer();
    });

    // Add / clear
    addBtn.addEventListener('click', () => {
      const name = (nameInput.value || "").trim() || "未命名段落";
      const prealertMin = parseInt(prealertSelect.value || "0", 10);

      const playSec = clampInt(parseInt(playSecondsInput.value || "10", 10), 1, 600);
      state.sound.playSeconds = playSec;

      if (currentMode === 'countdown') {
        const minutes = parseInt(minutesInput.value || "0", 10);
        if (!minutes || minutes <= 0) return;
        const t = createTimer({ name, mode: 'countdown', minutes, endtime: '', prealertMin });
        state.timers[t.id] = t;
        state.order.push(t.id);
        setActive(t.id);
        markControlled(t.id);
      } else {
        const endtime = endtimeInput.value;
        if (!endtime) return;
        const t = createTimer({ name, mode: 'endtime', minutes: 0, endtime, prealertMin });
        state.timers[t.id] = t;
        state.order.push(t.id);
        setActive(t.id);
        markControlled(t.id);
      }

      nameInput.value = "";
      render();
      saveState();
    });

    clearAllBtn.addEventListener('click', () => {
      for (const id of state.order) {
        const t = state.timers[id];
        if (t?.interval) clearInterval(t.interval);
      }
      state.order = [];
      state.timers = {};
      state.activeId = null;
      state.lastControlId = null;
      closeSnoozeSheet();
      render();
      saveState();
    });

    // Sound controls
    presetSelect.addEventListener('change', () => {
      const key = presetSelect.value;
      if (PRESET_SOUNDS[key]) {
        state.sound.preset = key;
        state.sound.customUrl = null;
        state.sound.customName = null;

        audio.src = PRESET_SOUNDS[key].url;
        fileInput.value = "";
        fileName.textContent = "未選擇";

        saveState();
      }
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      state.sound.customUrl = url;
      state.sound.customName = file.name || "custom-audio";
      audio.src = url;
      fileName.textContent = state.sound.customName;
      saveState();
    });

    volumeSlider.addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      state.sound.volume = v;
      audio.volume = v;
      saveState();
    });

    playSecondsInput.addEventListener('input', () => {
      const v = clampInt(parseInt(playSecondsInput.value || "10", 10), 1, 600);
      state.sound.playSeconds = v;
      saveState();
    });

    previewBtn.addEventListener('click', () => playAlertSound());
    stopBtn.addEventListener('click', () => stopAudio());

    // Restore
    function hydrateFromStorage(data) {
      state.nextId = data.nextId || 1;
      state.order = Array.isArray(data.order) ? data.order : [];
      state.activeId = data.activeId ?? null;
      state.lastControlId = data.lastControlId ?? null;

      const s = data.sound || {};
      state.sound.preset = s.preset || "soft";
      state.sound.volume = typeof s.volume === "number" ? s.volume : 0.7;
      state.sound.playSeconds = clampInt(parseInt(s.playSeconds || 10, 10), 1, 600);
      state.sound.customName = s.customName || null;
      state.sound.customUrl = null;

      presetSelect.value = state.sound.preset;
      volumeSlider.value = String(state.sound.volume);
      playSecondsInput.value = String(state.sound.playSeconds);

      audio.volume = state.sound.volume;
      audio.src = PRESET_SOUNDS[state.sound.preset]?.url || PRESET_SOUNDS.soft.url;

      fileName.textContent = state.sound.customName ? `${state.sound.customName}（重開需重選）` : "未選擇";

      state.timers = {};
      const timersList = Array.isArray(data.timers) ? data.timers : [];
      for (const t of timersList) {
        const id = t.id|0;
        state.timers[id] = {
          id,
          name: t.name || `段落 ${id}`,
          mode: t.mode === "endtime" ? "endtime" : "countdown",
          minutes: t.minutes|0,
          endtime: t.endtime || "",
          prealertMin: t.prealertMin|0,
          remainingMs: typeof t.remainingMs === "number" ? t.remainingMs : 0,
          targetTs: null,
          interval: null,
          prealertTriggered: !!t.prealertTriggered,
          status: t.status || "尚未開始",
          finished: !!t.finished
        };
      }

      state.order = state.order.filter(id => !!state.timers[id]);
      if (state.activeId && !state.timers[state.activeId]) state.activeId = null;
      if (state.lastControlId && !state.timers[state.lastControlId]) state.lastControlId = null;
    }

    // Init
    (function init(){
      const saved = loadState();
      if (saved) hydrateFromStorage(saved);

      setMode('countdown');
      pwaHint.textContent = "時間守門員";

      render();
      saveState();
    })();
  </script>
</body>
</html>
